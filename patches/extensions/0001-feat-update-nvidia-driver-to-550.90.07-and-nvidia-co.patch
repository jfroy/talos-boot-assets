From e36fe63c387b89e1fb1f95c1954a9ddadf00fa13 Mon Sep 17 00:00:00 2001
From: Jean-Francois Roy <jf@devklog.net>
Date: Tue, 16 Jul 2024 09:34:01 -0700
Subject: [PATCH] feat: update nvidia driver to 550.90.07 and nvidia container
 toolkit to v1.16.1

---
 .../nvidia-container-cli/pkg.yaml                |  6 +++---
 .../nvidia-container-runtime/pkg.yaml            |  6 +++---
 .../nvidia-pkgs/pkg.yaml                         |  8 ++++----
 nvidia-gpu/vars.yaml                             | 16 ++++++++--------
 4 files changed, 18 insertions(+), 18 deletions(-)

diff --git a/nvidia-gpu/nvidia-container-toolkit/nvidia-container-cli/pkg.yaml b/nvidia-gpu/nvidia-container-toolkit/nvidia-container-cli/pkg.yaml
index b57b10d..e7c6e5f 100644
--- a/nvidia-gpu/nvidia-container-toolkit/nvidia-container-cli/pkg.yaml
+++ b/nvidia-gpu/nvidia-container-toolkit/nvidia-container-cli/pkg.yaml
@@ -28,10 +28,10 @@ dependencies:
     from: /rootfs
 steps:
   - sources:
-      - url: https://gitlab.com/nvidia/container-toolkit/libnvidia-container/-/archive/{{ .LIBNVIDIA_CONTAINER_VERSION }}/libnvidia-container-{{ .LIBNVIDIA_CONTAINER_VERSION }}.tar.gz
+      - url: https://github.com/NVIDIA/libnvidia-container/archive/refs/tags/{{ .LIBNVIDIA_CONTAINER_VERSION }}.tar.gz
         destination: libnvidia-container.tar.gz
-        sha256: 13a626b6fdfe1d98be754af5b80b59a8887dd4250ae199919a7a1ed513e03a3e
-        sha512: c9dd1fcf0534c53259a9f23a07ad89f17933484bea903a89bcb3abd792c3dee1a340f9e7c42047e90969ca8eea7e7c4a5e7dba759a7a5871d2aac4bc01f61ab8
+        sha256: cbc1dda7ee90b8b729c5f178292cd07b421863015d84b84c37e69c8d580ab3ff
+        sha512: b304c284c5ab0c3544362307dc16ffcca8d34497e4356a520dc6da81a86a62b2a262b528cba559bb0d7a3addf018c3b50b6cb78669c82c1b4acae159e5922548
     env:
       SOURCE_DATE_EPOCH: {{ .BUILD_ARG_SOURCE_DATE_EPOCH }}
       REVISION: {{ .LIBNVIDIA_CONTAINER_REF }}
diff --git a/nvidia-gpu/nvidia-container-toolkit/nvidia-container-runtime/pkg.yaml b/nvidia-gpu/nvidia-container-toolkit/nvidia-container-runtime/pkg.yaml
index e38b3a0..cbb7cfd 100644
--- a/nvidia-gpu/nvidia-container-toolkit/nvidia-container-runtime/pkg.yaml
+++ b/nvidia-gpu/nvidia-container-toolkit/nvidia-container-runtime/pkg.yaml
@@ -10,10 +10,10 @@ dependencies:
   - image: cgr.dev/chainguard/wolfi-base@{{ .WOLFI_BASE_REF }}
 steps:
   - sources:
-      - url: https://gitlab.com/nvidia/container-toolkit/container-toolkit/-/archive/{{ .CONTAINER_TOOLKIT_VERSION }}/container-toolkit-{{ .CONTAINER_TOOLKIT_VERSION }}.tar.gz
+      - url: https://github.com/NVIDIA/nvidia-container-toolkit/archive/refs/tags/{{ .CONTAINER_TOOLKIT_VERSION }}.tar.gz
         destination: container-toolkit.tar.gz
-        sha256: 5284f689b8c55181cf215444dde3c0171cff5edde183f060f1e7e0611c055ce6
-        sha512: 49d87b316db0002d0b79c5f6c31fff78f3e54bf0310c396d7fc8d88b5d9f7ec4bd629547983a25530d9a709b872907c5941892733fef81df99a6764a00f6b229
+        sha256: 38a193444e0342c0a2c0d3664403e2c341eb77f1461b3f9172fd93c04de82165
+        sha512: 691d4fc47ea60b730ec491b333aa8118bcfd62cdab20a42b84155c6a13484d920e758435b5029bbae4fbefce82352aa5764f1554992682f689c95615809fb83c
     env:
       GIT_COMMIT: {{ substr 0 7 .CONTAINER_TOOLKIT_REF }} # build is using short sha
     prepare:
diff --git a/nvidia-gpu/nvidia-container-toolkit/nvidia-pkgs/pkg.yaml b/nvidia-gpu/nvidia-container-toolkit/nvidia-pkgs/pkg.yaml
index 84c2191..16f72f9 100644
--- a/nvidia-gpu/nvidia-container-toolkit/nvidia-pkgs/pkg.yaml
+++ b/nvidia-gpu/nvidia-container-toolkit/nvidia-pkgs/pkg.yaml
@@ -13,13 +13,13 @@ steps:
     # {{ if eq .ARCH "aarch64" }} This in fact is YAML comment, but Go templating instruction is evaluated by bldr
       - url: https://download.nvidia.com/XFree86/Linux-aarch64/{{ .NVIDIA_DRIVER_VERSION }}/NVIDIA-Linux-aarch64-{{ .NVIDIA_DRIVER_VERSION }}.run
         destination: nvidia.run
-        sha256: 8ba8d961457a241bcdf91b76d6fe2f36cb473c8bbdb02fb6650a622ce2e85b33
-        sha512: 706de7e53b81f909d8bc6a12a39c594754a164c49f5d23c7939dc3abcfc04f5d5b12b7d65762ae574582149a098f06ee5fe95be4f8ad1056a3307a6ce93f3c00
+        sha256: b896b76ae465307afc5b269c40bd8ccb279e6ea7d3ecae95534a91ecb1971572
+        sha512: 79b956ad890a096bfb00c9dd996cba0673200b1d61f702ea6c5c64ca3fe2cefdd61e2bc844fdb7b4668c2796af5399be51e6f511565c3799cf731de2a7e9efaa
     # {{ else }} This in fact is YAML comment, but Go templating instruction is evaluated by bldr
       - url: https://download.nvidia.com/XFree86/Linux-x86_64/{{ .NVIDIA_DRIVER_VERSION }}/NVIDIA-Linux-x86_64-{{ .NVIDIA_DRIVER_VERSION }}-no-compat32.run
         destination: nvidia.run
-        sha256: ffed07a30323fd6cf9caad3fb45e6259223135f6004d832511921a788f719ba6
-        sha512: f75c288b27a17ea8c63dac68cda01b94184b41332778df6a702d30d814c407c1e45f30bd7c81511508ace6560a16e79c24e8698f457aaee3ee1d03c57725ab27
+        sha256: 5a92545013649d6435d46fc8b5af617f4e3fdea78ee435e034c14bc47557c117
+        sha512: 9df55bd659c909d879a95e9b740487ba69c8b30be1f2c43be405c41899b3ad8eb493daaed9f0eca02d8a78729fcdd49e00c3d86e9c2b39a7644724bbf8195386
     # {{ end }} This in fact is YAML comment, but Go templating instruction is evaluated by bldr
     prepare:
       - |
diff --git a/nvidia-gpu/vars.yaml b/nvidia-gpu/vars.yaml
index d4911dd..51addea 100644
--- a/nvidia-gpu/vars.yaml
+++ b/nvidia-gpu/vars.yaml
@@ -1,12 +1,12 @@
 # only update if there's a matching fabric manager version
-# renovate: datasource=github-releases depName=nvidia/open-gpu-kernel-modules
-NVIDIA_DRIVER_VERSION: 535.129.03
-# renovate: datasource=git-tags depName=https://gitlab.com/nvidia/container-toolkit/container-toolkit.git
-CONTAINER_TOOLKIT_VERSION: v1.14.6
-CONTAINER_TOOLKIT_REF: 5605d191332dcfeea802c4497360d60a65c7887e
-# renovate: datasource=git-tags depName=https://gitlab.com/nvidia/container-toolkit/libnvidia-container.git
-LIBNVIDIA_CONTAINER_VERSION: v1.14.6
-LIBNVIDIA_CONTAINER_REF: d2eb0afe86f0b643e33624ee64f065dd60e952d4
+  # cannot use renovate from nvidia/open-gpu-kernel-modules as it will pick up all sorts of pre-release versions
+NVIDIA_DRIVER_VERSION: 550.90.07
+# renovate: datasource=github-releases depName=NVIDIA/nvidia-container-toolkit
+CONTAINER_TOOLKIT_VERSION: v1.16.1
+CONTAINER_TOOLKIT_REF: a470818ba7d9166be282cd0039dd2fc9b0a34d73
+# renovate: datasource=github-releases depName=NVIDIA/libnvidia-container
+LIBNVIDIA_CONTAINER_VERSION: v1.16.1
+LIBNVIDIA_CONTAINER_REF: 4c2494f16573b585788a42e9c7bee76ecd48c73d
 # renovate: datasource=docker versioning=docker depName=cgr.dev/chainguard/wolfi-base
 WOLFI_BASE_REF: sha256:3d6dece13cdb5546cd03b20e14f9af354bc1a56ab5a7b47dca3e6c1557211fcf
 # renovate: datasource=git-tags extractVersion=^glibc-(?<version>.*)$ depName=https://sourceware.org/git/glibc.git
-- 
2.46.0

